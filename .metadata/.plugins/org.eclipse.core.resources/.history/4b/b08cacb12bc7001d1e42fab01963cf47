/*
 * SCHED.c
 *
 *  Created on: Mar 18, 2023
 *      Author: samir
 */



/*====================================================================================================*/
/******************************************** includes ************************************************/
/*====================================================================================================*/
#include "SYSTICK/SYSTICK.h"

#include "SCHED/SCHED.h"



/******************************************** End of includes *****************************************/
/*====================================================================================================*/




/*====================================================================================================*/
/********************************************* defines ************************************************/
/*====================================================================================================*/

#define FLAG_H          1
#define FLAG_L          0

/********************************************* End Of defines *****************************************/
/*====================================================================================================*/



/*====================================================================================================*/
/********************************************** types *************************************************/
/*====================================================================================================*/
typedef struct 
{
   taskInfo_t* Taskinfo;
   u32 Remain; 
}Task_t;

static Task_t Tasks[MAX_SCHED_SIZE] ;



/********************************************* End Of types *******************************************/
/*====================================================================================================*/


/*====================================================================================================*/
/********************************************** variables *********************************************/
/*====================================================================================================*/
u32 GLO_schedFlag = FLAG_L;

/********************************************** End variables *****************************************/
/*====================================================================================================*/




/*====================================================================================================*/
/*************************************** Static Function Prototypes ***********************************/
/*====================================================================================================*/
static void Sched(void);
static void tickCbf(void);
/***************************************** End Static Function ***************************************/
/*====================================================================================================*/


/*====================================================================================================*/
/************************************* implementation of APIs *****************************************/
/*====================================================================================================*/
void SCHED_init(void)
{
    u32 idx;
    SYSTICK_enableINT();
    SYSTICK_setCallBackFunc(&tickCbf);
    SYSTICK_setTick_ms(TICK_T);
    for ( idx = 0; idx < MAX_SCHED_SIZE; idx++)
    {
        Tasks[idx].Taskinfo = &TaskInfo[idx];
        Tasks[idx].Remain = TaskInfo->startDelay;
    }
    

}


void SCHED_start (void)
{
    SYSTICK_start();
    while(1)
    {
        if (GLO_schedFlag)
        {
            Sched();
            GLO_schedFlag = FLAG_L;
        }   
    }
    
}

/****************************************** End Of APIs ***********************************************/
/*====================================================================================================*/


/*====================================================================================================*/
/************************************* Static Function implementation *********************************/
/*====================================================================================================*/

static void Sched()
{
    u32 idx;
    for ( idx = 0; idx < MAX_SCHED_SIZE; idx++)
    {
        if(Tasks[idx].Taskinfo)
        {
            if(Tasks[idx].Remain==0)
            {
                Tasks[idx].Taskinfo->cbf();
                Tasks[idx].Remain = Tasks[idx].Taskinfo->startDelay;

            }
            Tasks[idx].Remain -= TICK_T;
        }
    }
    
}

static void tickCbf(void)
{
    if(GLO_schedFlag == 0)
    {
    	GLO_schedFlag = FLAG_H;
    }
    else
    {
        #warning "Cpu 100%";
    }
}


/************************************ End Static Function implementation ******************************/
/*====================================================================================================*/




